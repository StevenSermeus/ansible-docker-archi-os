- name: Create user with sudo privileges
  tags:
    - bootstrap-ansible
    - always
  block:
    - name: Create user
      ansible.builtin.user:
        name: "{{ bootstrap_ansible_user_name }}"
        shell: /bin/zsh
        append: true
        state: present
        createhome: true
      when: ansible_user != 'root'
    - name: Add user to sudoers
      ansible.builtin.copy:
        content: "{{ bootstrap_ansible_user_name }} ALL=(ALL) NOPASSWD: ALL"
        dest: /etc/sudoers.d/{{ bootstrap_ansible_user_name }}
        owner: root
        group: root
        mode: "0440"
      when: ansible_user != 'root'

- name: Copy SSH key to user
  tags:
    - bootstrap-ansible
    - copy-ssh-key
    - always
  ansible.builtin.copy:
    content: "{{ lookup('file', bootstrap_ansible_ssh_key_path) }}"
    dest: "/home/{{ bootstrap_ansible_user_name }}/.ssh/authorized_keys"
    owner: "{{ bootstrap_ansible_user_name }}"
    group: "{{ bootstrap_ansible_user_name }}"
    mode: "0600"
  when: ansible_user != 'root'

- name: Create SSH keypair and copy public key to user
  tags:
    - bootstrap-ansible
    - always
  block:
    - name: Create SSH keypair
      delegate_to: localhost
      ansible.builtin.openssh_keypair:
        type: ecdsa
        size: 256
        path: ~/.ssh/{{ bootstrap_ansible_user_name }}_ansible_ecdsa
      register: ssh_key
